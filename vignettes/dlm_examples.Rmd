---
title: "Normal Dynamic Linear Models"
output: 
  rmarkdown::html_vignette:
    toc: True
author: "AndrÃ© F. B. Menezes"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
vignette: >
  %\VignetteIndexEntry{Dynamic Linear Models: Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 10,
  fig.height = 6)
```

```{r setup, message=FALSE}
library(RBATS)
```


# Introduction

This vignette will show examples of univariate Normal Dynamic Linear Models
(DLMs) in real application using the `RBATS` package.


# Bayesian Normal Dynamic Linear Models

Let the information set be represented as $D_t = \{D_0, \ldots, D_{t-1}\}$ at
any time, with $D_0$ referring to the initial prior information at $t=0$.
Assuming that $(\boldsymbol{\theta}_0 \mid D_0) \sim N[\mathbf{m}_0, \mathbf{C}_0]$,
for some known moments $\mathbf{m}_0$ and $\mathbf{C}_0$, the general normal
DLM is defined by:
\begin{eqnarray}\label{eq:dlm_equations}
Y_t &=& \mathbf{F}^\top_t\,\boldsymbol{\theta}_t + \nu_t, \quad \quad \nu_t \sim N[0, V_t]  \\
\boldsymbol{\theta}_t &=& \mathbf{G}_t\,\boldsymbol{\theta}_{t-1} + \boldsymbol{\omega}_t, \quad \boldsymbol{\omega}_t \sim N[\mathbf{0}, \mathbf{W}_t]
\end{eqnarray}
where $Y_t$ is the observation at time $t$, $\mathbf{F}_t$ is a $p\times 1$ regression vector with known constants at time $t$, $\nu_t$ is the observation error at time $t$, $\boldsymbol{\theta}_t$ is a $p\times 1$ state vector at time $t$, $\boldsymbol{\omega}_t$ is the state evolution error, $\mathbf{G}_t$ is a $p\times p$ known matrix describing the state evolution, $V_t$ is the observation variance, and $\mathbf{W}_t$ is the evolution variance-covariance matrix. This model is describe by the quadruple $\{\mathbf{F}_t, \mathbf{G}_t, V_t, \mathbf{W}_t\}$.

Two major model types can be distinguished: time series models where $\mathbf{F}_t=\mathbf{F}$ and $\mathbf{G}_t=\mathbf{G}$; and dynamic regression models where $\mathbf{F}_t=(X_{t,1},\ldots,X_{t,p})'_t$ and $\mathbf{G}=\mathbf{I}_p$, where $X_{t,i}$ denotes the $i$ covariate at time $t$ and $\mathbf{I}_p$ indicates the identity matrix of order $p$.

## Model components

DLMs are defined as the combination of simpler components based on the superposition principle to make it simple to identify process features. The superposition of $r \ge 1$ sub-models represented by $\{\F_i, \G_i, V_i, \W_i\}_t$, for $i=1, \cdots, r$, can be used to specify a DLM. By defining $\F_t^{\prime}=(\F_1^{\prime}, \cdots, \F_r^{\prime}), \G_t=\textrm{diag}(\G_1, \cdots, \G_r)_t$ and $\W_t=(\W_1, \cdots, \W_r)_t$, we can obtain the model described by the $r$ components.

In fact, the current version of RBATS package implements three main model
components: polynomial, seasonal and regressors. In the sequel, we show how
to define those models throughout the `dlm` function.

### Nonstationary polynomial trend models

These models are special case of time series model, where
$\mathbf{F}_t=\mathbf{F}$ and $\mathbf{G}_t=\mathbf{G}$. The simplest model
is the local level, where $\mathbf{F} = \mathbf{F} = 1$ and the scalar 
vector \theta_t represents the expected level of the series at time $t$, that is
$$
Y_t = \theta_t + \nu_t \quad \theta_t = \theta_{t-1} + \omega_t.
$$
The class of second order polynomial models has $\mathbf{F} = (1, 0)^\top$ and
$\mathbf{G} = \begin{pmatrix} 1 & 1 \\ 0 & 1 \end{pmatrix}$ and the 
state vector $\boldsymbol{\theta}_t = (\mu_t, \beta_t)$ has two elements,
the first representing the level and the second the growth.

The general $p$-order polynomial models have a p-dimensional state vector,
$\mathbf{F} = (1, 0, \ldots, 0)^\top$, and $\mathbf{G}$ matrix $p\times p$
of Jordan form, where the diagonal and superdiagonal elements are all equal
to one, that is
$$
\mathbf{G} = \begin{pmatrix}
1 & 1 & 0 & \cdots & 0 \\
0 & 1 & 1 & \cdots & 0 \\
0 & 0 & 1 & \cdots & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 0 & 0 & \cdots & 1
\end{pmatrix}
$$
Then, the element $\theta_{t,r}$ in the state vector represents the $r$-th
derivative or difference in the series trend at time $t$. It undergoes
random fluctuations over time, influenced by the corresponding elements
of the innovations vector $\boldsymbol{\omega}_t$.


### Regressions 

$\mathbf{F}_t=(X_{t,1},\ldots,X_{t,p})^\top$ and $\mathbf{G}=\mathbf{I}_p$, where $X_{t,i}$ denotes the $i$ covariate at time $t$ and $\mathbf{I}_p$ indicates the identity matrix of order $p$.

#### Autoregressions

The basic representation of autoregression models of order $p$ in state space
form consider $\mathbf{F}_t = (y_{t-1}, \ldots, y_{t-p})^\top$ and
$\mathbf{G}=\mathbf{I}_p$.

A common representation has $\mathbf{F}_t = (1, 0, \ldots, 0)^\top$ and
$$
\mathbf{G} = \begin{pmatrix}
\phi_1 & 1 & 0 & \ldots & 0 \\
\phi_2 & 0 & 1 & \ldots & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
\phi_{p-1} & 0 & 0 & \ldots & 1 \\
\phi_{p} & 0 & 0 & \ldots & 0 \\
\end{pmatrix}
$$
with $V_t = 0$ for all $t$ and $\mathbf{W}_t$ having zero entries except the
$\mathbf{W}_{1,1} = w_t > 0$



### Seasonal

#### Free form

#### Fourier form


## Inference



### Estimation of unknown time-varying observation variance


### Specification of evolution variance matrix

### Smoothing distribution


## Automatic Monitoring



# Examples

## Flow of the River Nile

This is the most common data to analyse. 

```{r}
model <- dlm(polynomial = list(order = 1, discount_factor = 0.95))
fit_model <- fit(model = model, y = c(Nile), a = matrix(1120, ncol = 1),
                 R = diag(100, 1))
fit_model
```












